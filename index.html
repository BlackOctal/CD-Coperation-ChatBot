<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CD Corporation Law Services - AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .company-logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .company-subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            padding: 8px 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #e74c3c;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #27ae60;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .message.user .message-avatar {
            background: #3498db;
        }

        .message.bot .message-avatar {
            background: #2c3e50;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
            border-bottom-right-radius: 8px;
        }

        .message.bot .message-content {
            background: white;
            color: #2c3e50;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e9ecef;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border-color 0.3s ease;
            max-height: 100px;
            min-height: 50px;
        }

        .chat-input:focus {
            border-color: #3498db;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            background: white;
            border-radius: 20px;
            border-bottom-left-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 70%;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #bdc3c7;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .welcome-message {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .welcome-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .chat-container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }
            
            .connection-status {
                position: static;
                margin-top: 15px;
            }
            
            .message-content {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="connection-status" id="connectionStatus">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="company-logo">CD Corporation Law Services</div>
            <div class="company-subtitle">AI Legal Education Assistant</div>
        </div>

        <div class="chat-messages" id="chatMessages">
            <div class="welcome-message">
                <div class="welcome-title">Welcome to CD Corporation Law Services AI Assistant</div>
                <p>I'm here to help staff members with legal education and guidance. Feel free to ask any questions!</p>
            </div>
        </div>

        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Type your legal question here..."
                    rows="1"
                    disabled
                ></textarea>
                <button class="send-button" id="sendButton" disabled>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22,2 15,22 11,13 2,9"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        class ChatInterface {
            constructor() {
                this.apiKey = '3MITheimN910GocVJbVeXbpUEuil3thOsLeGM42UCIXTl77ADsPAJQQJ99BHACHYHv6XJ3w3AAAAACOGDGZ3';
                this.endpoint = 'https://kevinpieris23-3739-resource.openai.azure.com/';
                this.apiUrl = 'https://kevinpieris23-3739-resource.services.ai.azure.com/api/projects/kevinpieris23-3739';
                this.isOnline = false;
                this.conversationHistory = [];
                
                this.initializeElements();
                this.setupEventListeners();
                this.checkConnection();
                this.setupAutoResize();
            }

            initializeElements() {
                this.chatMessages = document.getElementById('chatMessages');
                this.chatInput = document.getElementById('chatInput');
                this.sendButton = document.getElementById('sendButton');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.statusText = document.getElementById('statusText');
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }

            setupAutoResize() {
                this.chatInput.addEventListener('input', () => {
                    this.chatInput.style.height = '50px';
                    this.chatInput.style.height = Math.min(this.chatInput.scrollHeight, 100) + 'px';
                });
            }

            async checkConnection() {
                try {
                    this.updateStatus('Checking connection...', false);
                    
                    // Simple connectivity test - try to reach the endpoint
                    const testResponse = await fetch(this.endpoint, {
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    
                    // If we get here without error, assume connection is good
                    this.setOnlineStatus(true);
                    this.updateStatus('Online', true);
                    
                } catch (error) {
                    console.error('Connection test failed:', error);
                    // For now, let's assume we're online and let the actual API call handle errors
                    this.setOnlineStatus(true);
                    this.updateStatus('Online (Testing)', true);
                }
                
                // Recheck connection every 30 seconds
                setTimeout(() => this.checkConnection(), 30000);
            }

            setOnlineStatus(isOnline) {
                this.isOnline = isOnline;
                this.chatInput.disabled = !isOnline;
                this.sendButton.disabled = !isOnline;
                
                if (isOnline) {
                    this.chatInput.placeholder = "Type your legal question here...";
                } else {
                    this.chatInput.placeholder = "Service offline - please check configuration...";
                }
            }

            updateStatus(text, isOnline) {
                this.statusText.textContent = text;
                if (isOnline) {
                    this.statusIndicator.classList.add('online');
                } else {
                    this.statusIndicator.classList.remove('online');
                }
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || !this.isOnline) return;

                // Add user message
                this.addMessage(message, 'user');
                this.chatInput.value = '';
                this.chatInput.style.height = '50px';

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    // Call Azure OpenAI API
                    const response = await this.callAzureOpenAI(message);
                    this.hideTypingIndicator();
                    this.addMessage(response, 'bot');
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('I apologize, but I encountered an error processing your request. Please try again or contact your system administrator.', 'bot');
                    console.error('API call failed:', error);
                }
            }

            async callAzureOpenAI(message) {
                // Add message to conversation history
                this.conversationHistory.push({
                    role: "user",
                    content: message
                });

                try {
                    // Try multiple possible API endpoints for Azure AI Services
                    const possibleEndpoints = [
                        // Try most common and stable API versions first
                        `${this.endpoint}openai/deployments/gpt-4o-mini/chat/completions?api-version=2024-08-01-preview`,
                        `${this.endpoint}openai/deployments/gpt-4-mini/chat/completions?api-version=2024-08-01-preview`,
                        `${this.endpoint}openai/deployments/gpt-4/chat/completions?api-version=2024-08-01-preview`,
                        
                        // Try 2024-06-01 version (very common)
                        `${this.endpoint}openai/deployments/gpt-4o-mini/chat/completions?api-version=2024-06-01`,
                        `${this.endpoint}openai/deployments/gpt-4-mini/chat/completions?api-version=2024-06-01`,
                        `${this.endpoint}openai/deployments/gpt-4/chat/completions?api-version=2024-06-01`,
                        
                        // Try stable 2024-02-01 version
                        `${this.endpoint}openai/deployments/gpt-4o-mini/chat/completions?api-version=2024-02-01`,
                        `${this.endpoint}openai/deployments/gpt-4-mini/chat/completions?api-version=2024-02-01`,
                        `${this.endpoint}openai/deployments/gpt-4/chat/completions?api-version=2024-02-01`,
                        
                        // Try 2023 versions for compatibility
                        `${this.endpoint}openai/deployments/gpt-4o-mini/chat/completions?api-version=2023-12-01-preview`,
                        `${this.endpoint}openai/deployments/gpt-4-mini/chat/completions?api-version=2023-12-01-preview`,
                        `${this.endpoint}openai/deployments/gpt-4/chat/completions?api-version=2023-12-01-preview`,
                        `${this.endpoint}openai/deployments/gpt-35-turbo/chat/completions?api-version=2023-12-01-preview`,
                        
                        // Try your AI Services project endpoints
                        `${this.apiUrl}/chat/completions?api-version=2024-08-01-preview`,
                        `${this.apiUrl}/chat/completions?api-version=2024-06-01`,
                        `${this.apiUrl}/chat/completions?api-version=2024-02-01`,
                        `${this.apiUrl}/chat/completions?api-version=2023-12-01-preview`,
                        
                        // Try without specific deployment (let Azure route it)
                        `${this.endpoint}openai/chat/completions?api-version=2024-08-01-preview`,
                        `${this.endpoint}openai/chat/completions?api-version=2024-06-01`,
                        `${this.endpoint}openai/chat/completions?api-version=2024-02-01`,
                        `${this.endpoint}openai/chat/completions?api-version=2023-12-01-preview`
                    ];

                    const requestBody = {
                        messages: [
                            {
                                role: "system",
                                content: "You are a helpful AI assistant for CD Corporation Law Services, specializing in legal education for staff members. Provide clear, professional, and educational responses about legal matters. Always maintain a professional tone and remind users that your responses are for educational purposes only and should not replace professional legal advice."
                            },
                            ...this.conversationHistory
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    };

                    let lastError = null;
                    
                    // Try each endpoint
                    for (const endpoint of possibleEndpoints) {
                        try {
                            console.log(`Trying endpoint: ${endpoint}`);
                            
                            const response = await fetch(endpoint, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'api-key': this.apiKey,
                                    'Ocp-Apim-Subscription-Key': this.apiKey
                                },
                                body: JSON.stringify(requestBody)
                            });

                            console.log(`Response status: ${response.status}`);
                            
                            if (response.ok) {
                                const data = await response.json();
                                console.log('Success response:', data);
                                
                                let assistantMessage = '';
                                if (data.choices && data.choices[0] && data.choices[0].message) {
                                    assistantMessage = data.choices[0].message.content;
                                } else if (data.message) {
                                    assistantMessage = data.message;
                                } else if (data.response) {
                                    assistantMessage = data.response;
                                } else {
                                    assistantMessage = "I received your message but couldn't process it properly. Please try again.";
                                }
                                
                                // Add to conversation history
                                this.conversationHistory.push({
                                    role: "assistant",
                                    content: assistantMessage
                                });

                                return assistantMessage;
                            } else {
                                const errorText = await response.text();
                                console.log(`Error response: ${errorText}`);
                                lastError = new Error(`HTTP ${response.status}: ${errorText}`);
                            }
                        } catch (endpointError) {
                            console.log(`Endpoint ${endpoint} failed:`, endpointError);
                            lastError = endpointError;
                            continue;
                        }
                    }
                    
                    throw lastError || new Error('All endpoints failed');
                    
                } catch (error) {
                    console.error('All API calls failed:', error);
                    
                    // Remove the user message from history since we couldn't process it
                    this.conversationHistory.pop();
                    
                    // Return a helpful error message with debugging info
                    return `I'm having trouble connecting to the AI service. Please check:

1. Your deployment name in Azure OpenAI Studio
2. Make sure the API key is correct
3. Ensure the resource endpoints are accessible
4. Check the browser console for detailed error messages

Error details: ${error.message}

Please contact your system administrator for assistance.`;
                }
            }

            addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = sender === 'user' ? 'U' : 'AI';

                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = text;

                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString();

                contentDiv.appendChild(timeDiv);
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(contentDiv);

                // Remove welcome message if it exists
                const welcomeMessage = this.chatMessages.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }

                this.chatMessages.appendChild(messageDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            showTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message bot';
                typingDiv.id = 'typingIndicator';

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = 'AI';

                const typingContent = document.createElement('div');
                typingContent.className = 'typing-indicator';
                typingContent.style.display = 'block';

                const dotsDiv = document.createElement('div');
                dotsDiv.className = 'typing-dots';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'typing-dot';
                    dotsDiv.appendChild(dot);
                }

                typingContent.appendChild(dotsDiv);
                typingDiv.appendChild(avatar);
                typingDiv.appendChild(typingContent);

                this.chatMessages.appendChild(typingDiv);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
        }

        // Initialize the chat interface when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ChatInterface();
        });
    </script>
</body>
</html>
